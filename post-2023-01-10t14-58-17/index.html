<!DOCTYPE html>
<html lang="en">
  <head>
    <script defer data-domain="devnotes.tramline.app" src="https://plausible.io/js/script.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="https://devnotes.tramline.app/styles/styles.css">
    <link rel="stylesheet" href="https://devnotes.tramline.app/styles/header.css">
    <link rel="apple-touch-icon" sizes="180x180" href="https://devnotes.tramline.app/favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://devnotes.tramline.app/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://devnotes.tramline.app/favicon.png">
    <title>Tramline | Engineering notes</title>
    <style type="text/css">
     body {
       text-rendering: optimizeLegibility;
       -webkit-font-smoothing: antialiased;
       -moz-osx-font-smoothing: grayscale;
     }
    </style>
  </head>

  <body class="bg-tram-green-light bg-no-repeat bg-gradient-to-br min-h-screen border-b-8 border-tram-green">
    
<header>
  <div data-collapse="small" data-animation="default" data-duration="400" data-easing="ease" data-easing2="ease" role="banner" class="nav-bar w-nav">
    <div class="nav-container w-container">
      <div class="logo-div">
        <a href="https://tramline.app" aria-current="page" class="nav-logo w-inline-block w--current">
          <img src="https://devnotes.tramline.app/images/logo.png" loading="eager" width="50" alt="logo" class="logo">
        </a>
      </div>
      <nav role="navigation" class="nav-content w-nav-menu">
        <div class="nav-menu">
          <a href="/" aria-current="page" class="nav-link tramline w-nav-link w--current style-hNwNo" id="style-hNwNo">
            Tramline
            <p class="text-sm">engineering notes</p>
          </a>
        </div>
      </nav>
    </div>
  </div>
</header>

    <div class="border-b mb-3"></div>
    <main>
      <div class="px-2">
        <div class="mb-24 mt-16 px-4">
          <h1 data-w-id="18a9bc4c-33dd-e424-566d-cf277b93ef10" class="text-center heading-large style-J5dMq my-8" id="style-J5dMq">
            Short notes from engineering
          </h1>
          <div class="container max-w-[625px] mx-auto text-center
                      prose prose-lg
                      prose-a:border-b-[1px] prose-a:border-slate-500 prose-a:font-sans prose-a:no-underline
                      hover:prose-a:border-slate-200">
            <p>
              Micro-posts on programming and patterns as we build <a href="https://tramline.app" target="_blank">Tramline</a> in public.
              Follow this <a href="/atom.xml" target="_blank">feed</a> if you find these bits interesting.
            </p>
          </div>
        </div>
      </div>
      

<article class="container max-w-[900px] mx-auto my-8 px-2">
  <hr class="border-slate-200 mx-auto max-w-7xl">
  <div class="my-8"></div>
  <div class="md:flex">
    <div class="md:basis-[100px] md:flex-grow-0 md:flex-shrink-0 md:mr-4 px-1 ml-3 mb-8">
      <div class="font-medium my-2 leading-normal text-xs">
        <div class="tracking-wide">2023 &#x2F; Jan 10 â€” 14:58</div>
        <div class="mt-2 mb-2 underline">kitallis</div>
        <a href="https://devnotes.tramline.app/post-2023-01-10t14-58-17/">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">
            <g fill="none" class="nc-icon-wrapper">
              <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.71-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z" fill="#212121">
              </path>
            </g>
          </svg>
        </a>
      </div>
    </div>
    <div class="container max-w-[900px] mx-auto px-4">
      <div class="md:flex-grow md:ml-4">
        <div class="max-w-none
                    prose prose-md
                    prose-a:border-b-[1px] prose-a:border-slate-500 prose-a:font-sans prose-a:no-underline
                    hover:prose-a:border-b-slate-200
                    prose-pre:prose-code:prose-a:text-sm prose-code:prose-p:text-sm
                    prose-h1:font-bold prose-h1:text-base
                    prose-p:font-serif
                    prose-p:prose-blockquote:font-sans
                    prose-strong:font-sans
                    prose-ol:font-serif
                    prose-ul:font-serif">
		      <p>I have been using <code>return</code> a fair bit in transactions in Rails. In 7, these rollback the transaction and I use them as so.</p>
<p>They obviously require very careful writing and to <strong>remember</strong> that the return actually just doesn't jump out of the block, it cancels the transaction.</p>
<p>I prefer the fact that <code>return</code> from 8 will throw an exception, but I've found that using <code>Github::Result</code> around transactions as a pattern comes pretty close or is better (in some cases) already.</p>
<p>Consider this example code that creates and merges a pull request,</p>
<pre data-lang="ruby" style="background-color:#383838;color:#e6e1dc;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold;color:#86c20e;">def </span><span style="color:#f6aa11;">create_and_merge!
</span><span>  </span><span style="color:#cc7833;">return </span><span style="font-style:italic;color:#6e9cbe;">Result</span><span>.</span><span style="color:#86c20e;">new</span><span>(</span><span style="color:#f6f080;">ok?: </span><span style="color:#ae81ff;">false</span><span>) </span><span style="font-weight:bold;color:#86c20e;">unless</span><span> create.ok?
</span><span>  upserted_pull_request </span><span style="color:#cc7833;">=
</span><span>    </span><span style="color:#f6aa11;">@</span><span style="color:#d0d0ff;">new_pull_request</span><span>.update_or_insert!(create.value)
</span><span>
</span><span>  transaction </span><span style="color:#cc7833;">do
</span><span>    upserted_pull_request.close! </span><span style="color:#95815e;"># close the PR
</span><span>
</span><span>    </span><span style="font-weight:bold;color:#86c20e;">if</span><span> merge.ok?
</span><span>      </span><span style="font-style:italic;color:#6e9cbe;">Result</span><span>.</span><span style="color:#86c20e;">new</span><span>(</span><span style="color:#f6f080;">ok?: </span><span style="color:#ae81ff;">true</span><span>)
</span><span>    </span><span style="font-weight:bold;color:#86c20e;">else
</span><span>      </span><span style="color:#cc7833;">return </span><span style="font-style:italic;color:#6e9cbe;">Result</span><span>.</span><span style="color:#86c20e;">new</span><span>(</span><span style="color:#f6f080;">ok?: </span><span style="color:#ae81ff;">false</span><span>, </span><span style="color:#f6f080;">error: </span><span style="color:#f92672;">&quot;</span><span style="color:#c1be91;">Failed!</span><span style="color:#f92672;">&quot;</span><span>)
</span><span>    </span><span style="font-weight:bold;color:#86c20e;">end
</span><span>  </span><span style="font-weight:bold;color:#86c20e;">end
</span><span style="font-weight:bold;color:#86c20e;">end
</span><span>
</span><span style="font-weight:bold;color:#86c20e;">def </span><span style="color:#f6aa11;">create
</span><span>  </span><span style="color:#95815e;"># creates a PR and returns a Result
</span><span style="font-weight:bold;color:#86c20e;">end
</span><span>
</span><span style="font-weight:bold;color:#86c20e;">def </span><span style="color:#f6aa11;">merge
</span><span>  </span><span style="color:#95815e;"># merges a PR and returns a Result
</span><span style="font-weight:bold;color:#86c20e;">end
</span><span>
</span><span>Result </span><span style="color:#cc7833;">= </span><span style="font-style:italic;color:#6e9cbe;">Struct</span><span>.</span><span style="color:#86c20e;">new</span><span>(</span><span style="color:#f6f080;">:ok?</span><span>, </span><span style="color:#f6f080;">:error</span><span>, </span><span style="color:#f6f080;">:value</span><span>, </span><span style="color:#f6f080;">keyword_init: </span><span style="color:#ae81ff;">true</span><span>)
</span></code></pre>
<p>One problem here is that we're using custom <code>Result</code> objects which are not very chainable. But the other more shape-y problem is that we're having to check the output from <code>merge</code>, return an ok-<code>Result</code> or else <strong>cancel</strong> the transaction and <strong>then</strong> return a not-ok-<code>Result</code>. This not only feels like excessive work but also the use of <code>return</code> is unfortunate to essentially carry out a rollback + value type scenario.</p>
<p>With <code>Github::Result</code> we can rewrite it much more cleanly,</p>
<pre data-lang="ruby" style="background-color:#383838;color:#e6e1dc;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="font-weight:bold;color:#86c20e;">def </span><span style="color:#f6aa11;">create_and_merge!
</span><span>   </span><span style="color:#cc7833;">return </span><span style="font-style:italic;color:#6e9cbe;">GitHub</span><span>::</span><span style="font-style:italic;color:#6e9cbe;">Result</span><span>.</span><span style="color:#86c20e;">new </span><span>{ </span><span style="color:#86c20e;">raise </span><span style="color:#6e9cbe;">CreateError </span><span>} </span><span style="font-weight:bold;color:#86c20e;">unless</span><span> create.ok?
</span><span>   upserted_pull_request </span><span style="color:#cc7833;">=
</span><span>     </span><span style="color:#f6aa11;">@</span><span style="color:#d0d0ff;">new_pull_request</span><span>.update_or_insert!(create.value!)
</span><span>
</span><span>   </span><span style="font-style:italic;color:#6e9cbe;">GitHub</span><span>::</span><span style="font-style:italic;color:#6e9cbe;">Result</span><span>.</span><span style="color:#86c20e;">new </span><span style="color:#cc7833;">do
</span><span>     transaction </span><span style="color:#cc7833;">do
</span><span>       upserted_pull_request.close! </span><span style="color:#95815e;"># close the PR
</span><span>       merge.value!
</span><span>     </span><span style="font-weight:bold;color:#86c20e;">end
</span><span>  </span><span style="font-weight:bold;color:#86c20e;">end
</span><span style="font-weight:bold;color:#86c20e;">end
</span></code></pre>
<p>As long as <code>merge</code> throws an exception, <code>value!</code> will raise it, rollback (throwing an exception will rollback) and opaquely pass it further up to the wrappper <code>Result</code>. This allows us to avoid <code>return</code> magic and ugly raises in the middle of the transaction block and chain the exceptions up.</p>

        </div>
      </div>
	  </div>
  </div>
</article>


    </main>
  </body>
</html>
